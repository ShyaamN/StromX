<!DOCTYPE html>
<html>
<head>
    <title>StromX - Smoke Viz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: verdana; margin: 0; overflow: hidden; background-color: #1a1a1a; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 6px; }
        label { display: block; margin: 5px 0; cursor: pointer; font-size: 13px; }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">{"imports": {"three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"}}</script>
</head>
<body>
    <div id="ui">
        <b>Wind Tunnel (WIP)</b><br><br>
        <label><input type="checkbox" id="smoke" checked> Show smoke</label>
        <label><input type="checkbox" id="slice"> Slice view</label>
    </div>
<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // Smoke visualization using instanced rendering - way faster!
    let scene = new THREE.Scene(), camera, renderer, controls;
    let gridMesh, dummy = new THREE.Object3D();
    let showSmoke = true, sliceView = false;
    
    const res = 24, cellSize = 1.0/res;
    const totalCells = res * res * res;
    
    document.getElementById('smoke').onchange = (e) => showSmoke = e.target.checked;
    document.getElementById('slice').onchange = (e) => sliceView = e.target.checked;
    
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(1.5, 1.2, 2);
    renderer = new THREE.WebGLRenderer({ antialias: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x1a1a1a);
    document.body.appendChild(renderer.domElement);
    controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0.5, 0.5, 0.5);
    controls.update();
    
    // Instanced mesh for smoke
    gridMesh = new THREE.InstancedMesh(
        new THREE.BoxGeometry(cellSize, cellSize, cellSize),
        new THREE.MeshBasicMaterial({ transparent: true, depthWrite: false, blending: THREE.AdditiveBlending }),
        totalCells
    );
    scene.add(gridMesh);
    
    const box = new THREE.LineSegments(
        new THREE.EdgesGeometry(new THREE.BoxGeometry(1, 1, 1)),
        new THREE.LineBasicMaterial({ color: 0x444444 })
    );
    box.position.set(0.5, 0.5, 0.5);
    scene.add(box);
    
    let smokeData = new Float32Array(totalCells);
    let time = 0;
    
    function animate() {
        time += 0.016;
        
        // Fake some smoke movement for testing
        let idx = 0;
        const midSlice = Math.floor(res/2);
        for(let i=0; i<res; i++) {
            for(let j=0; j<res; j++) {
                for(let k=0; k<res; k++) {
                    // Add smoke at inlet
                    if(i < 3 && j > res*0.3 && j < res*0.7 && k > res*0.3 && k < res*0.7) {
                        smokeData[idx] = 0.8 + Math.sin(time*2) * 0.2;
                    } else {
                        smokeData[idx] *= 0.98; // Decay
                    }
                    
                    const hide = sliceView && k !== midSlice;
                    const alpha = showSmoke ? smokeData[idx] : 0;
                    
                    if(alpha < 0.02 || hide) {
                        dummy.scale.set(0,0,0);
                    } else {
                        dummy.position.set((i+0.5)*cellSize, (j+0.5)*cellSize, (k+0.5)*cellSize);
                        dummy.scale.set(0.9, 0.9, 0.9);
                    }
                    
                    dummy.updateMatrix();
                    gridMesh.setMatrixAt(idx, dummy.matrix);
                    gridMesh.setColorAt(idx, new THREE.Color(alpha*0.1, alpha*0.6, alpha));
                    idx++;
                }
            }
        }
        
        gridMesh.instanceMatrix.needsUpdate = true;
        if(gridMesh.instanceColor) gridMesh.instanceColor.needsUpdate = true;
        
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
    }
    animate();
    
    console.log('Smoke visualization working! Need to connect to real fluid sim');
</script>
</body>
</html>
